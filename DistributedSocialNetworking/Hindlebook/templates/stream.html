{% extends "base_header.html" %}
{% load staticfiles %}


{% block page %}

<div class="container">

    <!-- New Post Form -->
	<div class="row">
		<form id="post-form" action=".">
            {% include "post_form.html" %}
		</form>
	</div> <!-- /row -->
    <!-- /EndNewPostForm -->

    <!-- New Comment Form -->
    <div id="comment_form_html" class="row" hidden>
        <form id="comment-form" action=".">
            {% include "comment_form.html" %}
        </form>
    </div> <!-- /row -->

    <div id="stream">

	{% for post in posts %}
		{% include "post.html" %}
			{% for comment in post.getComments %}
                {% include "comment.html" %}
			{% endfor %}
        <div id="{{ post.uuid }}"></div>
        <div>
            <button data-postUUID="{{ post.uuid }}" class="add_comment_button btn btn-xs btn-success" value="submit">
                <i class="icon-rocket2"></i> Add Comment
            </button>
        </div>
	{% endfor %}
    </div> <!-- /stream -->
</div> <!-- /container --->
{% endblock %}

{% block scripts %}
<script>

    /* Post Ajax */
    var base_url = "/post/create/";

    var form_options = {
        success: postSuccess,
        dataType: "json",
        error: ajaxError,
        clearForm : false,
        type : "PUT",
        beforeSubmit : beforeSubmit
    }

    $('#post-form').ajaxForm(form_options);

    function beforeSubmit(arr, form, options) {
        console.log(options["url"]);
        options["url"] = base_url + $("#uuid").val();
        console.log(options["url"]);
    }

    function postSuccess(response, status, xhr, form) {
        console.log("Form was valid!");
        $('#post-form').html(response["form"]);
        $('#post-form').clearForm();
        $('#stream').prepend(response["post"]);
    }

    function ajaxError(xhr, errmsg, err) {
        var response;
        console.log(xhr.status + ": " + xhr.responseText);
        response = JSON.parse(xhr.responseText);
        $('#post-form').html(response["form"]);
    }

    /* End Post Ajax */

    /* Comment Ajax*/
    var base_comment_url = "/post/";
    var commentPostUUID;

    var comment_form_options = {
        success: commentSuccess,
        dataType: "json",
        error: ajaxErrorComment,
        clearForm : false,
        type : "PUT",
        beforeSubmit : beforeSubmitComment
    }

    $('#comment-form').ajaxForm(comment_form_options);

    function beforeSubmitComment(arr, form, options) {
        console.log(options["url"]);
        options["url"] = base_comment_url + $("#comment-form").data("postUUID") +"/create/" + $("#comment-uuid").val();
        console.log(options["url"]);
    }

    function commentSuccess(response, status, xhr, form) {
        console.log("Form was valid!");
        console.log(response["comment"]);
        var postUUID = $("#comment-form").data("postUUID");
        $('#comment-form').html(response["form"]);
        $('#comment-form').clearForm();
        $('#' + postUUID).before(response["comment"]);
        $("#comment_form_html").hide();
        $(".add_comment_button").show();
    }

    function ajaxErrorComment(xhr, errmsg, err) {
        var response;
        console.log(xhr.status + ": " + xhr.responseText);
        response = JSON.parse(xhr.responseText);
        $('#comment-form').html(response["form"]);
    }


    $(".add_comment_button").click(function(event) {
        var data = $(this).attr("data-postUUID");
        console.log(data);
        $(".add_comment_button").show();
        $(this).hide();
        $("#comment_form_html").hide();
        $("#"+ data ).after($("#comment_form_html"))
        $("#comment_form_html").show();
    });

        $(".add_comment_button").click(function(event) {
        var data = $(this).attr("data-postUUID");
        console.log(data);

        $(".add_comment_button").show();
        $(this).hide();
        $("#comment_form_html").hide();
        $("#"+ data ).after($("#comment_form_html"))
        $("#comment_form_html").show();
        $("#comment-form").data("postUUID", data);
        console.log($("#comment-form").data("postUUID"));
    });

    /* End Comment Ajax */
</script>
{% endblock scripts %}